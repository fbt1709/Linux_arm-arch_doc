# 如何生成 pubkey.bin

## 概述

`pubkey.bin` 是从私钥文件中提取的公钥，以二进制 DER 格式存储。在 ARM Trusted Firmware 中，公钥通常用于：
- 平台 ROTPK（Root of Trust Public Key）存储
- 证书验证
- 密钥分发

## 方法一：使用 OpenSSL（推荐）

### 1. 从 PEM 格式私钥提取公钥

如果您的私钥是 PEM 格式（`.pem` 或 `.key` 文件）：

```bash
# 方法 1：直接提取为 DER 格式
openssl pkey -in private_key.pem -inform PEM -pubout -out pubkey.bin -outform DER

# 方法 2：先提取为 PEM，再转换为 DER
openssl pkey -in private_key.pem -pubout -out pubkey.pem
openssl pkey -in pubkey.pem -inform PEM -out pubkey.bin -outform DER
```

### 2. 从 DER 格式私钥提取公钥

如果您的私钥已经是 DER 格式：

```bash
openssl pkey -in private_key.der -inform DER -pubout -out pubkey.bin -outform DER
```

### 3. 针对不同密钥类型的命令

#### RSA 密钥

```bash
# PEM 格式私钥
openssl rsa -in rsa_private_key.pem -pubout -out pubkey.bin -outform DER

# DER 格式私钥
openssl rsa -in rsa_private_key.der -inform DER -pubout -out pubkey.bin -outform DER
```

#### ECDSA 密钥

```bash
# PEM 格式私钥
openssl ec -in ecdsa_private_key.pem -pubout -out pubkey.bin -outform DER

# DER 格式私钥
openssl ec -in ecdsa_private_key.der -inform DER -pubout -out pubkey.bin -outform DER
```

### 4. 命令参数说明

| 参数 | 说明 |
|------|------|
| `-in <file>` | 输入私钥文件路径 |
| `-inform PEM/DER` | 输入文件格式（PEM 或 DER） |
| `-pubout` | 输出公钥（而不是私钥） |
| `-out <file>` | 输出文件路径 |
| `-outform PEM/DER` | 输出文件格式（PEM 或 DER） |

## 方法二：使用 cert_create 工具（TF-A 内置）

TF-A 的 `cert_create` 工具在生成证书时会自动提取公钥，但不会直接生成 `pubkey.bin` 文件。不过，您可以通过以下方式获取：

### 1. 从证书中提取公钥

```bash
# 首先生成证书（cert_create 会自动提取公钥到证书中）
cert_create --soc-fw-key-cert soc_fw_key.crt --soc-fw-key private_key.pem ...

# 然后从证书中提取公钥
openssl x509 -in soc_fw_key.crt -pubkey -noout -out pubkey.pem
openssl pkey -in pubkey.pem -inform PEM -out pubkey.bin -outform DER
```

## 方法三：使用 Python 脚本

如果您需要批量处理或自动化，可以使用 Python：

```python
#!/usr/bin/env python3
"""
从私钥文件提取公钥并保存为 DER 格式
"""
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa, ec
from cryptography.hazmat.backends import default_backend
import sys

def extract_public_key(private_key_path, output_path, key_format='PEM'):
    """
    从私钥文件提取公钥
    
    Args:
        private_key_path: 私钥文件路径
        output_path: 输出公钥文件路径
        key_format: 私钥格式 ('PEM' 或 'DER')
    """
    # 读取私钥
    with open(private_key_path, 'rb') as f:
        private_key_data = f.read()
    
    # 根据格式加载私钥
    if key_format.upper() == 'PEM':
        private_key = serialization.load_pem_private_key(
            private_key_data,
            password=None,
            backend=default_backend()
        )
    else:  # DER
        private_key = serialization.load_der_private_key(
            private_key_data,
            password=None,
            backend=default_backend()
        )
    
    # 提取公钥
    public_key = private_key.public_key()
    
    # 序列化为 DER 格式
    public_key_der = public_key.public_bytes(
        encoding=serialization.Encoding.DER,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    )
    
    # 保存到文件
    with open(output_path, 'wb') as f:
        f.write(public_key_der)
    
    print(f"Public key extracted and saved to {output_path}")

if __name__ == '__main__':
    if len(sys.argv) < 3:
        print("Usage: python3 extract_pubkey.py <private_key_file> <output_file> [PEM|DER]")
        sys.exit(1)
    
    private_key_path = sys.argv[1]
    output_path = sys.argv[2]
    key_format = sys.argv[3] if len(sys.argv) > 3 else 'PEM'
    
    extract_public_key(private_key_path, output_path, key_format)
```

使用方法：

```bash
# 从 PEM 格式私钥提取
python3 extract_pubkey.py private_key.pem pubkey.bin PEM

# 从 DER 格式私钥提取
python3 extract_pubkey.py private_key.der pubkey.bin DER
```

## 实际应用示例

### 示例 1：生成 ROTPK（Root of Trust Public Key）

```bash
# 1. 生成私钥（如果还没有）
openssl genrsa -out rot_key.pem 2048

# 2. 提取公钥为 DER 格式
openssl rsa -in rot_key.pem -pubout -out rot_pubkey.bin -outform DER

# 3. 或者使用通用命令
openssl pkey -in rot_key.pem -pubout -out rot_pubkey.bin -outform DER
```

### 示例 2：从 TF-A 生成的密钥提取公钥

```bash
# TF-A 使用 cert_create 生成密钥时，通常保存在 build/<platform>/ 目录
cd build/fvp/release/

# 假设您有 soc_fw_content_key.pem
openssl pkey -in soc_fw_content_key.pem -pubout -out soc_fw_content_pubkey.bin -outform DER
```

### 示例 3：验证提取的公钥

```bash
# 查看公钥信息（PEM 格式）
openssl pkey -in pubkey.bin -inform DER -pubin -text -noout

# 或者转换为 PEM 格式查看
openssl pkey -in pubkey.bin -inform DER -pubin -out pubkey.pem -outform PEM
cat pubkey.pem
```

## 常见问题

### Q1: 如何知道私钥的格式？

```bash
# 查看文件内容
head -1 private_key.pem
# 如果是 PEM 格式，会看到：-----BEGIN PRIVATE KEY----- 或 -----BEGIN RSA PRIVATE KEY-----

# 或者使用 file 命令
file private_key.pem
# PEM 格式通常显示为：ASCII text
# DER 格式通常显示为：data
```

### Q2: 如何验证提取的公钥是否正确？

```bash
# 方法 1：比较公钥的 hash
openssl pkey -in private_key.pem -pubout | openssl sha256
openssl pkey -in pubkey.bin -inform DER -pubin | openssl sha256
# 两个 hash 应该相同

# 方法 2：使用公钥验证签名
# （需要先创建一个测试签名）
```

### Q3: 支持哪些密钥类型？

OpenSSL 的 `pkey` 命令支持：
- RSA
- ECDSA（包括各种曲线：secp256r1, secp384r1, secp521r1 等）
- Ed25519
- Ed448
- X25519
- X448

### Q4: 如何从证书中提取公钥？

```bash
# 从 X.509 证书提取公钥
openssl x509 -in certificate.crt -pubkey -noout -out pubkey.pem
openssl pkey -in pubkey.pem -inform PEM -out pubkey.bin -outform DER
```

## 在 TF-A 中的使用场景

### 1. 平台 ROTPK 存储

某些平台需要将 ROTPK 存储为二进制格式：

```bash
# 生成 ROTPK
openssl pkey -in rot_key.pem -pubout -out rotpk.bin -outform DER

# 然后在平台代码中使用
# 例如：plat_get_rotpk_info() 函数会读取这个文件
```

### 2. 密钥验证

在验证证书时，公钥会从证书中动态提取，但某些场景可能需要预先存储：

```c
// 代码中会从证书提取公钥到缓冲区
static unsigned char content_pk_buf[PK_DER_LEN];

// 这个缓冲区在运行时从证书中填充，不需要硬编码
```

## 总结

生成 `pubkey.bin` 的最简单方法是使用 OpenSSL：

```bash
# 通用命令（推荐）
openssl pkey -in private_key.pem -pubout -out pubkey.bin -outform DER

# RSA 密钥专用
openssl rsa -in rsa_private_key.pem -pubout -out pubkey.bin -outform DER

# ECDSA 密钥专用
openssl ec -in ecdsa_private_key.pem -pubout -out pubkey.bin -outform DER
```

**注意事项**：
1. 确保私钥文件格式正确（PEM 或 DER）
2. 输出格式指定为 `DER` 以生成二进制文件
3. 使用 `-pubout` 参数确保输出的是公钥
4. 在生产环境中，确保私钥文件的安全存储

---

**参考文档**：
- OpenSSL 文档：https://www.openssl.org/docs/
- TF-A 认证框架：`docs/design/auth-framework.rst`
