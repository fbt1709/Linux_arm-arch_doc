# cert_create 中密钥参数最终生成什么并放到证书中

## 概述

在 `cert_create` 工具中，传入的各种密钥参数（如 `--soc-fw-key`, `--trusted-world-key`, `--rot-key`, `--tos-fw-key` 等）有**三个主要用途**：

1. **作为证书的 Subject Public Key**（证书本身的主体公钥）
2. **作为证书扩展中的公钥**（用于分发下一级证书的公钥）
3. **作为签名密钥**（用于对证书进行数字签名）

**重要说明**：
- 证书签名使用的是**私钥**，不是加密，而是**数字签名**
- 签名密钥来自 issuer（签发者）证书的密钥
- Subject Public Key 来自证书自己的密钥

---

## 密钥参数的三个用途

### 用途 1：作为证书的 Subject Public Key

**cert.c 第 102 行和 176 行**：

```c
int cert_new(...)
{
    EVP_PKEY *pkey = keys[cert->key].key;  // ← 从证书定义获取密钥
    
    // ...
    
    X509_set_pubkey(x, pkey);  // ← 设置为证书的 Subject Public Key
}
```

**作用**：
- 证书的 Subject Public Key Info 字段
- 用于验证证书的签名
- 每个证书都有且只有一个 Subject Public Key

### 用途 2：作为证书扩展中的公钥

**main.c 第 534-537 行**：

```c
case EXT_TYPE_PKEY:
    CHECK_NULL(cert_ext, ext_new_key(ext_nid,
        EXT_CRIT, keys[ext->attr.key].key));  // ← 从扩展定义获取密钥
    break;
```

**作用**：
- X.509 扩展中的公钥
- 用于分发下一级证书的公钥
- 可以有多个公钥扩展（如 Trusted Key Cert 包含多个公钥）

### 用途 3：作为签名密钥（数字签名）

**cert.c 第 103-104 行和 138-139 行**：

```c
int cert_new(...)
{
    cert_t *issuer_cert = &certs[cert->issuer];
    EVP_PKEY *ikey = keys[issuer_cert->key].key;  // ← 从 issuer 证书获取签名密钥
    
    // ...
    
    /* Sign the certificate with the issuer key */
    if (!EVP_DigestSignInit(mdCtx, &pKeyCtx, get_digest(md_alg), NULL, ikey)) {
        // ← 使用 issuer 的私钥进行数字签名
    }
    
    // ...
    
    if (!X509_sign_ctx(x, mdCtx)) {  // ← 签名证书
        ERR_print_errors_fp(stdout);
        goto END;
    }
}
```

**作用**：
- **数字签名**（不是加密）：使用私钥对证书内容进行签名
- 签名密钥来自 issuer（签发者）证书的密钥
- 用于验证证书的完整性和真实性
- 验证时使用对应的公钥验证签名

**重要区别**：
- ✅ **数字签名**：使用私钥签名，公钥验证（非对称加密）
- ❌ **不是加密**：证书内容本身是明文的，只是添加了签名

---

## 各密钥参数的详细说明

### 1. `--rot-key` (ROT_KEY)

**用途**：
- ✅ **Subject Public Key**：用于 Trusted Key Certificate 和 Trusted Boot FW Certificate
- ✅ **签名密钥**：用于签名这些证书

**生成的证书**：

| 证书 | Subject Public Key | 签名密钥 | 扩展中的公钥 |
|------|-------------------|---------|-------------|
| **TRUSTED_KEY_CERT** | ROT_KEY 的公钥 | ROT_KEY 的私钥 | TRUSTED_WORLD_PK, NON_TRUSTED_WORLD_PK |
| **TRUSTED_BOOT_FW_CERT** | ROT_KEY 的公钥 | ROT_KEY 的私钥 | TB_FW_HASH, TB_FW_CONFIG_HASH |
| **FWU_CERT** | ROT_KEY 的公钥 | ROT_KEY 的私钥 | SCP_FWU_CFG_HASH, AP_FWU_CFG_HASH, FWU_HASH |

**代码位置**（tbb_cert.c 第 36-50 行）：

```c
[TRUSTED_KEY_CERT] = {
    .key = ROT_KEY,              // ← Subject Public Key
    .issuer = TRUSTED_KEY_CERT,  // ← 自签名，使用 ROT_KEY 签名
    .ext = {
        TRUSTED_WORLD_PK_EXT,    // ← 扩展：Trusted World Key 的公钥
        NON_TRUSTED_WORLD_PK_EXT // ← 扩展：Non-Trusted World Key 的公钥
    }
}
```

**最终结果**：
- 证书的 Subject Public Key Info：ROT_KEY 的公钥
- 证书扩展：Trusted World Key 和 Non-Trusted World Key 的公钥

---

### 2. `--trusted-world-key` (TRUSTED_WORLD_KEY)

**用途**：
- ✅ **Subject Public Key**：用于 Trusted World 的 Key Certificate
- ✅ **签名密钥**：用于签名这些 Key Certificate
- ✅ **扩展中的公钥**：添加到 Trusted Key Certificate 的扩展中

**生成的证书**：

| 证书 | Subject Public Key | 签名密钥 | 扩展中的公钥 |
|------|-------------------|---------|-------------|
| **SOC_FW_KEY_CERT** | TRUSTED_WORLD_KEY 的公钥 | TRUSTED_WORLD_KEY 的私钥 | SOC_FW_CONTENT_CERT_PK |
| **SCP_FW_KEY_CERT** | TRUSTED_WORLD_KEY 的公钥 | TRUSTED_WORLD_KEY 的私钥 | SCP_FW_CONTENT_CERT_PK |
| **TRUSTED_OS_FW_KEY_CERT** | TRUSTED_WORLD_KEY 的公钥 | TRUSTED_WORLD_KEY 的私钥 | TOS_FW_CONTENT_CERT_PK |

**代码位置**（tbb_cert.c 第 79-91 行）：

```c
[SOC_FW_KEY_CERT] = {
    .key = TRUSTED_WORLD_KEY,    // ← Subject Public Key
    .issuer = SOC_FW_KEY_CERT,   // ← 自签名，使用 TRUSTED_WORLD_KEY 签名
    .ext = {
        SOC_FW_CONTENT_CERT_PK_EXT  // ← 扩展：Content Cert Key 的公钥
    }
}
```

**扩展定义**（tbb_ext.c 第 83-89 行）：

```c
[TRUSTED_WORLD_PK_EXT] = {
    .type = EXT_TYPE_PKEY,
    .attr.key = TRUSTED_WORLD_KEY  // ← 关联到 TRUSTED_WORLD_KEY
}
```

**最终结果**：
- **Trusted Key Certificate** 的扩展：包含 TRUSTED_WORLD_KEY 的公钥
- **SOC_FW_KEY_CERT** 的 Subject Public Key：TRUSTED_WORLD_KEY 的公钥
- **SOC_FW_KEY_CERT** 的扩展：包含 SOC_FW_CONTENT_CERT_KEY 的公钥

---

### 3. `--soc-fw-key` (SOC_FW_CONTENT_CERT_KEY)

**用途**：
- ✅ **Subject Public Key**：用于 SOC_FW_CONTENT_CERT
- ✅ **签名密钥**：用于签名 Content Certificate
- ✅ **扩展中的公钥**：添加到 SOC_FW_KEY_CERT 的扩展中

**生成的证书**：

| 证书 | Subject Public Key | 签名密钥 | 扩展中的公钥 |
|------|-------------------|---------|-------------|
| **SOC_FW_CONTENT_CERT** | SOC_FW_CONTENT_CERT_KEY 的公钥 | SOC_FW_CONTENT_CERT_KEY 的私钥 | SOC_AP_FW_HASH, SOC_FW_CONFIG_HASH |

**代码位置**（tbb_cert.c 第 93-106 行）：

```c
[SOC_FW_CONTENT_CERT] = {
    .key = SOC_FW_CONTENT_CERT_KEY,  // ← Subject Public Key
    .issuer = SOC_FW_CONTENT_CERT,   // ← 自签名
    .ext = {
        SOC_AP_FW_HASH_EXT,          // ← 扩展：BL31 的 hash
        SOC_FW_CONFIG_HASH_EXT        // ← 扩展：Config 的 hash
    }
}
```

**扩展定义**（tbb_ext.c 第 116-123 行）：

```c
[SOC_FW_CONTENT_CERT_PK_EXT] = {
    .type = EXT_TYPE_PKEY,
    .attr.key = SOC_FW_CONTENT_CERT_KEY  // ← 关联到 SOC_FW_CONTENT_CERT_KEY
}
```

**最终结果**：
- **SOC_FW_KEY_CERT** 的扩展：包含 SOC_FW_CONTENT_CERT_KEY 的公钥
- **SOC_FW_CONTENT_CERT** 的 Subject Public Key：SOC_FW_CONTENT_CERT_KEY 的公钥
- **SOC_FW_CONTENT_CERT** 的扩展：包含 BL31 和 Config 的 hash

---

### 4. `--tos-fw-key` (TRUSTED_OS_FW_CONTENT_CERT_KEY)

**用途**：
- ✅ **Subject Public Key**：用于 TRUSTED_OS_FW_CONTENT_CERT
- ✅ **签名密钥**：用于签名 Content Certificate
- ✅ **扩展中的公钥**：添加到 TRUSTED_OS_FW_KEY_CERT 的扩展中

**生成的证书**：

| 证书 | Subject Public Key | 签名密钥 | 扩展中的公钥 |
|------|-------------------|---------|-------------|
| **TRUSTED_OS_FW_CONTENT_CERT** | TOS_FW_CONTENT_CERT_KEY 的公钥 | TOS_FW_CONTENT_CERT_KEY 的私钥 | TOS_FW_HASH, TOS_FW_EXTRA1_HASH, TOS_FW_EXTRA2_HASH |

**代码位置**（tbb_cert.c 第 122-138 行）：

```c
[TRUSTED_OS_FW_CONTENT_CERT] = {
    .key = TRUSTED_OS_FW_CONTENT_CERT_KEY,  // ← Subject Public Key
    .ext = {
        TRUSTED_OS_FW_HASH_EXT,              // ← 扩展：BL32 的 hash
        TRUSTED_OS_FW_EXTRA1_HASH_EXT,       // ← 扩展：BL32 Extra1 的 hash
        TRUSTED_OS_FW_EXTRA2_HASH_EXT        // ← 扩展：BL32 Extra2 的 hash
    }
}
```

**最终结果**：
- **TRUSTED_OS_FW_KEY_CERT** 的扩展：包含 TOS_FW_CONTENT_CERT_KEY 的公钥
- **TRUSTED_OS_FW_CONTENT_CERT** 的 Subject Public Key：TOS_FW_CONTENT_CERT_KEY 的公钥
- **TRUSTED_OS_FW_CONTENT_CERT** 的扩展：包含 BL32 相关镜像的 hash

---

### 5. `--non-trusted-world-key` (NON_TRUSTED_WORLD_KEY)

**用途**：
- ✅ **Subject Public Key**：用于 NON_TRUSTED_FW_KEY_CERT
- ✅ **签名密钥**：用于签名 Key Certificate
- ✅ **扩展中的公钥**：添加到 Trusted Key Certificate 的扩展中

**生成的证书**：

| 证书 | Subject Public Key | 签名密钥 | 扩展中的公钥 |
|------|-------------------|---------|-------------|
| **NON_TRUSTED_FW_KEY_CERT** | NON_TRUSTED_WORLD_KEY 的公钥 | NON_TRUSTED_WORLD_KEY 的私钥 | NT_FW_CONTENT_CERT_PK |

**最终结果**：
- **Trusted Key Certificate** 的扩展：包含 NON_TRUSTED_WORLD_KEY 的公钥
- **NON_TRUSTED_FW_KEY_CERT** 的 Subject Public Key：NON_TRUSTED_WORLD_KEY 的公钥
- **NON_TRUSTED_FW_KEY_CERT** 的扩展：包含 NT_FW_CONTENT_CERT_KEY 的公钥

---

## 完整映射表

| 密钥参数 | 密钥 ID | 作为 Subject Public Key 的证书 | 作为扩展公钥的证书 | 扩展名称 |
|---------|---------|------------------------------|-----------------|---------|
| `--rot-key` | ROT_KEY | TRUSTED_KEY_CERT<br>TRUSTED_BOOT_FW_CERT<br>FWU_CERT | TRUSTED_KEY_CERT | TRUSTED_WORLD_PK_EXT<br>NON_TRUSTED_WORLD_PK_EXT |
| `--trusted-world-key` | TRUSTED_WORLD_KEY | SOC_FW_KEY_CERT<br>SCP_FW_KEY_CERT<br>TRUSTED_OS_FW_KEY_CERT | TRUSTED_KEY_CERT | TRUSTED_WORLD_PK_EXT |
| `--non-trusted-world-key` | NON_TRUSTED_WORLD_KEY | NON_TRUSTED_FW_KEY_CERT | TRUSTED_KEY_CERT | NON_TRUSTED_WORLD_PK_EXT |
| `--soc-fw-key` | SOC_FW_CONTENT_CERT_KEY | SOC_FW_CONTENT_CERT | SOC_FW_KEY_CERT | SOC_FW_CONTENT_CERT_PK_EXT |
| `--tos-fw-key` | TOS_FW_CONTENT_CERT_KEY | TRUSTED_OS_FW_CONTENT_CERT | TRUSTED_OS_FW_KEY_CERT | TOS_FW_CONTENT_CERT_PK_EXT |
| `--nt-fw-key` | NT_FW_CONTENT_CERT_KEY | NON_TRUSTED_FW_CONTENT_CERT | NON_TRUSTED_FW_KEY_CERT | NT_FW_CONTENT_CERT_PK_EXT |
| `--scp-fw-key` | SCP_FW_CONTENT_CERT_KEY | SCP_FW_CONTENT_CERT | SCP_FW_KEY_CERT | SCP_FW_CONTENT_CERT_PK_EXT |

---

## 实际示例

### 示例：生成所有证书

```bash
cert_create \
    # ROT_KEY - 用于 Trusted Key Cert 和 Trusted Boot FW Cert
    --rot-key rot_key.pem \
    
    # TRUSTED_WORLD_KEY - 用于 Trusted World 的 Key Cert
    --trusted-world-key trusted_world_key.pem \
    
    # NON_TRUSTED_WORLD_KEY - 用于 Non-Trusted World 的 Key Cert
    --non-trusted-world-key non_trusted_world_key.pem \
    
    # SOC_FW_CONTENT_CERT_KEY - 用于 BL31 的 Content Cert
    --soc-fw-key soc_fw_content_key.pem \
    
    # TOS_FW_CONTENT_CERT_KEY - 用于 BL32 的 Content Cert
    --tos-fw-key tos_fw_content_key.pem \
    
    # NT_FW_CONTENT_CERT_KEY - 用于 BL33 的 Content Cert
    --nt-fw-key nt_fw_content_key.pem \
    
    # 输出证书
    --trusted-key-cert trusted_key.crt \
    --soc-fw-key-cert soc_fw_key.crt \
    --soc-fw-cert soc_fw_content.crt \
    --tos-fw-key-cert tos_fw_key.crt \
    --tos-fw-cert tos_fw_content.crt \
    --nt-fw-key-cert nt_fw_key.crt \
    --nt-fw-cert nt_fw_content.crt \
    ...
```

### 生成的证书内容

#### 1. Trusted Key Certificate (`trusted_key.crt`)

```
Subject Public Key Info: ROT_KEY 的公钥 ← --rot-key
Signature: ROT_KEY 的私钥签名
X.509 Extensions:
    ├─ TRUSTED_WORLD_PK_EXT: TRUSTED_WORLD_KEY 的公钥 ← --trusted-world-key
    └─ NON_TRUSTED_WORLD_PK_EXT: NON_TRUSTED_WORLD_KEY 的公钥 ← --non-trusted-world-key
```

#### 2. SOC_FW_KEY_CERT (`soc_fw_key.crt`)

```
Subject Public Key Info: TRUSTED_WORLD_KEY 的公钥 ← --trusted-world-key
Signature: TRUSTED_WORLD_KEY 的私钥签名
X.509 Extensions:
    └─ SOC_FW_CONTENT_CERT_PK_EXT: SOC_FW_CONTENT_CERT_KEY 的公钥 ← --soc-fw-key
```

#### 3. SOC_FW_CONTENT_CERT (`soc_fw_content.crt`)

```
Subject Public Key Info: SOC_FW_CONTENT_CERT_KEY 的公钥 ← --soc-fw-key
Signature: SOC_FW_CONTENT_CERT_KEY 的私钥签名
X.509 Extensions:
    ├─ SOC_AP_FW_HASH_EXT: BL31 的 hash ← --soc-fw bl31.bin
    └─ SOC_FW_CONFIG_HASH_EXT: Config 的 hash ← --soc-fw-config
```

---

## 密钥的两个角色

### 角色 1：证书的 Subject Public Key

**cert.c 第 102 行和 176 行**：

```c
EVP_PKEY *pkey = keys[cert->key].key;  // ← 从证书定义获取
X509_set_pubkey(x, pkey);              // ← 设置为 Subject Public Key
```

**作用**：
- 证书本身的主体公钥
- 用于验证证书的签名
- 每个证书只有一个

**示例**：
- `SOC_FW_CONTENT_CERT.key = SOC_FW_CONTENT_CERT_KEY`
- 所以 `--soc-fw-key` 指定的密钥的公钥会成为 `SOC_FW_CONTENT_CERT` 的 Subject Public Key

### 角色 2：证书扩展中的公钥

**main.c 第 534-537 行**：

```c
case EXT_TYPE_PKEY:
    ext_new_key(ext_nid, EXT_CRIT, keys[ext->attr.key].key);
    // ← 从扩展定义获取密钥，创建公钥扩展
```

**作用**：
- X.509 扩展中的公钥
- 用于分发下一级证书的公钥
- 可以有多个

**示例**：
- `SOC_FW_CONTENT_CERT_PK_EXT.attr.key = SOC_FW_CONTENT_CERT_KEY`
- 所以 `--soc-fw-key` 指定的密钥的公钥会被添加到 `SOC_FW_KEY_CERT` 的扩展中

---

## 完整流程示例

### 以 `--soc-fw-key` 为例

```
1. 命令行指定密钥文件
   ↓
   --soc-fw-key soc_fw_content_key.pem
   ↓
2. cert_create 加载密钥
   ↓
   keys[SOC_FW_CONTENT_CERT_KEY].key = 加载的密钥
   ↓
3. 生成 SOC_FW_KEY_CERT
   ↓
   - Subject Public Key: TRUSTED_WORLD_KEY 的公钥
   - 扩展: SOC_FW_CONTENT_CERT_KEY 的公钥 ← 使用 --soc-fw-key
   ↓
4. 生成 SOC_FW_CONTENT_CERT
   ↓
   - Subject Public Key: SOC_FW_CONTENT_CERT_KEY 的公钥 ← 使用 --soc-fw-key
   - 扩展: BL31 的 hash
```

---

## 完整示例：密钥的三个用途

### 以 `--trusted-world-key` 为例

```bash
cert_create \
    --trusted-world-key trusted_world_key.pem \
    --trusted-key-cert trusted_key.crt \
    --soc-fw-key-cert soc_fw_key.crt \
    ...
```

**生成的证书内容**：

#### 1. Trusted Key Certificate (`trusted_key.crt`)

```
Subject Public Key Info: ROT_KEY 的公钥
Signature: ROT_KEY 的私钥签名 ← 用途 3：签名密钥
X.509 Extensions:
    └─ TRUSTED_WORLD_PK_EXT: TRUSTED_WORLD_KEY 的公钥 ← 用途 2：扩展中的公钥
```

#### 2. SOC_FW_KEY_CERT (`soc_fw_key.crt`)

```
Subject Public Key Info: TRUSTED_WORLD_KEY 的公钥 ← 用途 1：Subject Public Key
Signature: TRUSTED_WORLD_KEY 的私钥签名 ← 用途 3：签名密钥（自签名）
X.509 Extensions:
    └─ SOC_FW_CONTENT_CERT_PK_EXT: SOC_FW_CONTENT_CERT_KEY 的公钥 ← 用途 2：扩展中的公钥
```

**关键点**：
- `TRUSTED_WORLD_KEY` 的**公钥**作为 `SOC_FW_KEY_CERT` 的 Subject Public Key（用途 1）
- `TRUSTED_WORLD_KEY` 的**私钥**用于签名 `SOC_FW_KEY_CERT`（用途 3）
- `TRUSTED_WORLD_KEY` 的**公钥**被添加到 `Trusted Key Cert` 的扩展中（用途 2）

---

## 总结

### 密钥参数的三个用途

| 密钥参数 | 用途 1：Subject Public Key | 用途 2：扩展中的公钥 | 用途 3：签名密钥 |
|---------|--------------------------|---------------------|----------------|
| `--rot-key` | Trusted Key Cert<br>Trusted Boot FW Cert | Trusted Key Cert 的扩展 | 签名 Trusted Key Cert<br>签名 Trusted Boot FW Cert |
| `--trusted-world-key` | SOC_FW_KEY_CERT<br>SCP_FW_KEY_CERT<br>TOS_FW_KEY_CERT | Trusted Key Cert 的扩展 | 签名 Key Certificates |
| `--soc-fw-key` | SOC_FW_CONTENT_CERT | SOC_FW_KEY_CERT 的扩展 | 签名 SOC_FW_CONTENT_CERT |
| `--tos-fw-key` | TOS_FW_CONTENT_CERT | TOS_FW_KEY_CERT 的扩展 | 签名 TOS_FW_CONTENT_CERT |
| `--nt-fw-key` | NT_FW_CONTENT_CERT | NT_FW_KEY_CERT 的扩展 | 签名 NT_FW_CONTENT_CERT |

### 关键点

1. **每个密钥有三个用途**：
   - **用途 1**：作为某个证书的 Subject Public Key（由 `cert->key` 指定）
   - **用途 2**：作为另一个证书扩展中的公钥（由 `ext->attr.key` 指定）
   - **用途 3**：作为签名密钥，用于签名证书（由 issuer 证书的 `cert->key` 指定）

2. **Subject Public Key**：
   - 由证书定义中的 `.key` 字段指定
   - 用于验证证书的签名

3. **扩展中的公钥**：
   - 由扩展定义中的 `.attr.key` 字段指定
   - 用于分发下一级证书的公钥

4. **签名密钥**：
   - 由 issuer（签发者）证书的 `.key` 字段指定
   - 使用**私钥**对证书进行数字签名
   - 验证时使用对应的公钥验证签名

5. **数字签名 vs 加密**：
   - ✅ **数字签名**：使用私钥签名，公钥验证（非对称加密）
   - ❌ **不是加密**：证书内容本身是明文的，只是添加了签名

6. **自动处理**：
   - cert_create 会自动从密钥文件提取公钥和私钥
   - 自动添加到相应的位置（Subject Public Key Info、扩展、签名）

---

**参考代码**：
- 证书定义：`tools/cert_create/src/tbbr/tbb_cert.c`
- 扩展定义：`tools/cert_create/src/tbbr/tbb_ext.c`
- 证书生成：`tools/cert_create/src/cert.c` 第 95-212 行
- 扩展处理：`tools/cert_create/src/main.c` 第 473-552 行
