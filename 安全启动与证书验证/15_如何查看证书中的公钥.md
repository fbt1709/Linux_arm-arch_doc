# 如何查看证书中的公钥

## 概述

证书中的公钥有两个位置：
1. **Subject Public Key Info**：证书本身的主体公钥
2. **X.509 扩展**：用于分发下一级证书的公钥

本文将介绍如何使用 OpenSSL 工具查看这些公钥。

---

## 方法一：使用 OpenSSL 查看（推荐）

### 1. 查看证书的 Subject Public Key

#### 基本命令

```bash
# 查看证书的 Subject Public Key（PEM 格式）
openssl x509 -in certificate.crt -pubkey -noout

# 查看证书的 Subject Public Key（DER 格式）
openssl x509 -in certificate.crt -pubkey -noout -outform DER > pubkey.der

# 查看证书的 Subject Public Key 详细信息
openssl x509 -in certificate.crt -pubkey -noout | openssl pkey -pubin -text -noout
```

#### 完整证书信息（包含 Subject Public Key）

```bash
# 查看完整证书信息
openssl x509 -in certificate.crt -text -noout

# 只查看 Subject Public Key Info 部分
openssl x509 -in certificate.crt -text -noout | grep -A 20 "Subject Public Key Info"
```

### 2. 查看证书扩展中的公钥

#### 查看所有扩展

```bash
# 查看证书的所有扩展
openssl x509 -in certificate.crt -text -noout | grep -A 10 "X509v3 extensions"

# 或者更详细
openssl x509 -in certificate.crt -text -noout -extensions 1.3.6.1.4.1.4128.2100.601
```

#### 查看特定 OID 的扩展

```bash
# 查看特定 OID 的扩展（例如 SOC_FW_CONTENT_CERT_PK_OID）
openssl x509 -in soc_fw_key.crt -text -noout | grep -A 5 "1.3.6.1.4.1.4128.2100.601"

# 或者使用 asn1parse 查看
openssl asn1parse -in certificate.crt -strparse <offset>
```

### 3. 提取并验证公钥

#### 提取 Subject Public Key

```bash
# 提取为 PEM 格式
openssl x509 -in certificate.crt -pubkey -noout > subject_pubkey.pem

# 提取为 DER 格式
openssl x509 -in certificate.crt -pubkey -noout -outform DER > subject_pubkey.der

# 查看公钥信息
openssl pkey -pubin -in subject_pubkey.pem -text -noout
```

#### 提取扩展中的公钥

```bash
# 使用 Python 脚本提取（见下文）
# 或使用 OpenSSL 的 asn1parse 工具
```

---

## 方法二：使用 Python 脚本提取

### 1. 提取 Subject Public Key

```python
#!/usr/bin/env python3
"""
提取证书的 Subject Public Key
"""
from cryptography import x509
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.backends import default_backend
import sys

def extract_subject_public_key(cert_path):
    """提取证书的 Subject Public Key"""
    with open(cert_path, 'rb') as f:
        cert_data = f.read()
    
    # 解析证书
    cert = x509.load_pem_x509_certificate(cert_data, default_backend())
    
    # 获取 Subject Public Key
    public_key = cert.public_key()
    
    # 序列化为 PEM 格式
    pem = public_key.public_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    )
    
    print("Subject Public Key:")
    print(pem.decode())
    
    # 序列化为 DER 格式
    der = public_key.public_bytes(
        encoding=serialization.Encoding.DER,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    )
    
    print(f"\nDER length: {len(der)} bytes")
    return public_key

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print("Usage: python3 extract_subject_pubkey.py <certificate.crt>")
        sys.exit(1)
    
    extract_subject_public_key(sys.argv[1])
```

### 2. 提取扩展中的公钥

```python
#!/usr/bin/env python3
"""
提取证书扩展中的公钥
"""
from cryptography import x509
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.backends import default_backend
import sys

# TF-A 使用的 OID
OIDS = {
    "TRUSTED_WORLD_PK": "1.3.6.1.4.1.4128.2100.302",
    "NON_TRUSTED_WORLD_PK": "1.3.6.1.4.1.4128.2100.303",
    "SOC_FW_CONTENT_CERT_PK": "1.3.6.1.4.1.4128.2100.601",
    "TOS_FW_CONTENT_CERT_PK": "1.3.6.1.4.1.4128.2100.602",
    "NT_FW_CONTENT_CERT_PK": "1.3.6.1.4.1.4128.2100.603",
}

def extract_extension_public_key(cert_path, oid):
    """提取证书扩展中的公钥"""
    with open(cert_path, 'rb') as f:
        cert_data = f.read()
    
    # 解析证书
    cert = x509.load_pem_x509_certificate(cert_data, default_backend())
    
    # 查找扩展
    try:
        ext = cert.extensions.get_extension_for_oid(x509.ObjectIdentifier(oid))
        print(f"Found extension: {ext.oid}")
        print(f"Critical: {ext.critical}")
        
        # 提取公钥数据（DER 格式）
        public_key_der = ext.value.value
        
        # 解析公钥
        from cryptography.hazmat.primitives.serialization import load_der_public_key
        public_key = load_der_public_key(public_key_der, default_backend())
        
        # 序列化为 PEM 格式
        pem = public_key.public_bytes(
            encoding=serialization.Encoding.PEM,
            format=serialization.PublicFormat.SubjectPublicKeyInfo
        )
        
        print("\nPublic Key:")
        print(pem.decode())
        return public_key
        
    except x509.ExtensionNotFound:
        print(f"Extension with OID {oid} not found")
        return None

if __name__ == '__main__':
    if len(sys.argv) < 3:
        print("Usage: python3 extract_ext_pubkey.py <certificate.crt> <OID>")
        print("\nAvailable OIDs:")
        for name, oid in OIDS.items():
            print(f"  {name}: {oid}")
        sys.exit(1)
    
    cert_path = sys.argv[1]
    oid = sys.argv[2]
    
    # 如果传入的是名称，转换为 OID
    if oid in OIDS:
        oid = OIDS[oid]
    
    extract_extension_public_key(cert_path, oid)
```

---

## 实际示例

### 示例 1：查看 Trusted Key Certificate

```bash
# 查看完整证书信息
openssl x509 -in trusted_key.crt -text -noout

# 查看 Subject Public Key
openssl x509 -in trusted_key.crt -pubkey -noout

# 查看扩展中的公钥
openssl x509 -in trusted_key.crt -text -noout | grep -A 10 "TrustedWorldPublicKey"
openssl x509 -in trusted_key.crt -text -noout | grep -A 10 "NonTrustedWorldPublicKey"
```

**输出示例**：

```
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: ...
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = Trusted Key Certificate
        Validity
            Not Before: ...
            Not After : ...
        Subject: CN = Trusted Key Certificate
        Subject Public Key Info:          ← 这是 Subject Public Key
            Public Key Algorithm: rsaEncryption
            RSA Public-Key: (2048 bit)
            Modulus:
                00:aa:bb:cc:...
            Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Subject Key Identifier: ...
            X509v3 Authority Key Identifier: ...
            1.3.6.1.4.1.4128.2100.302:    ← Trusted World PK 扩展
                ..not printable..
            1.3.6.1.4.1.4128.2100.303:    ← Non-Trusted World PK 扩展
                ..not printable..
```

### 示例 2：查看 SOC_FW_KEY_CERT

```bash
# 查看证书信息
openssl x509 -in soc_fw_key.crt -text -noout

# 查看 Subject Public Key（应该是 TRUSTED_WORLD_KEY 的公钥）
openssl x509 -in soc_fw_key.crt -pubkey -noout | openssl pkey -pubin -text -noout

# 查看扩展中的公钥（应该是 SOC_FW_CONTENT_CERT_KEY 的公钥）
openssl x509 -in soc_fw_key.crt -text -noout | grep -A 5 "1.3.6.1.4.1.4128.2100.601"
```

### 示例 3：比较公钥

```bash
# 提取 Trusted Key Cert 的 Subject Public Key
openssl x509 -in trusted_key.crt -pubkey -noout > trusted_key_subject_pk.pem

# 提取 Trusted Key Cert 扩展中的 Trusted World PK
# （需要使用 Python 脚本或 asn1parse）

# 比较两个公钥是否相同
openssl pkey -pubin -in trusted_key_subject_pk.pem -text -noout
```

---

## 方法三：使用 OpenSSL asn1parse 查看

### 查看证书的 ASN.1 结构

```bash
# 查看证书的 ASN.1 结构
openssl asn1parse -in certificate.crt -i

# 查看特定偏移量的数据
openssl asn1parse -in certificate.crt -strparse <offset>

# 查找 Subject Public Key Info
openssl asn1parse -in certificate.crt | grep "BIT STRING"
```

---

## 方法四：验证公钥是否正确

### 1. 验证 Subject Public Key 与密钥文件匹配

```bash
# 从证书提取 Subject Public Key
openssl x509 -in certificate.crt -pubkey -noout > cert_pubkey.pem

# 从私钥提取公钥
openssl pkey -in private_key.pem -pubout > key_pubkey.pem

# 比较两个公钥
diff cert_pubkey.pem key_pubkey.pem

# 或者比较 hash
openssl pkey -pubin -in cert_pubkey.pem | openssl sha256
openssl pkey -pubin -in key_pubkey.pem | openssl sha256
```

### 2. 验证扩展中的公钥

```bash
# 提取扩展中的公钥（使用 Python 脚本）
python3 extract_ext_pubkey.py soc_fw_key.crt SOC_FW_CONTENT_CERT_PK

# 从密钥文件提取公钥
openssl pkey -in soc_fw_content_key.pem -pubout > soc_fw_content_key_pub.pem

# 比较
diff <(python3 extract_ext_pubkey.py soc_fw_key.crt SOC_FW_CONTENT_CERT_PK) \
     soc_fw_content_key_pub.pem
```

---

## 快速检查脚本

### 完整检查脚本

```bash
#!/bin/bash
# check_cert_keys.sh - 检查证书中的公钥

CERT_FILE=$1

if [ -z "$CERT_FILE" ]; then
    echo "Usage: $0 <certificate.crt>"
    exit 1
fi

echo "=== Certificate: $CERT_FILE ==="
echo ""

echo "1. Subject Public Key Info:"
openssl x509 -in "$CERT_FILE" -pubkey -noout | openssl pkey -pubin -text -noout | head -10
echo ""

echo "2. All Extensions:"
openssl x509 -in "$CERT_FILE" -text -noout | grep -A 5 "X509v3 extensions"
echo ""

echo "3. Public Key Extensions:"
openssl x509 -in "$CERT_FILE" -text -noout | grep -E "(TrustedWorldPublicKey|NonTrustedWorldPublicKey|ContentCertPK|FirmwareContentCertPK)" -A 3
echo ""

echo "4. Certificate Details:"
openssl x509 -in "$CERT_FILE" -text -noout | grep -E "(Subject:|Issuer:|Signature Algorithm)" -A 1
```

**使用方法**：

```bash
chmod +x check_cert_keys.sh
./check_cert_keys.sh trusted_key.crt
./check_cert_keys.sh soc_fw_key.crt
./check_cert_keys.sh soc_fw_content.crt
```

---

## 常见 OID 列表

### TF-A TBBR 使用的公钥扩展 OID

| 扩展名称 | OID | 说明 |
|---------|-----|------|
| **TRUSTED_WORLD_PK_EXT** | `1.3.6.1.4.1.4128.2100.302` | Trusted World 公钥 |
| **NON_TRUSTED_WORLD_PK_EXT** | `1.3.6.1.4.1.4128.2100.303` | Non-Trusted World 公钥 |
| **SCP_FW_CONTENT_CERT_PK_EXT** | `1.3.6.1.4.1.4128.2100.600` | SCP Content Cert 公钥 |
| **SOC_FW_CONTENT_CERT_PK_EXT** | `1.3.6.1.4.1.4128.2100.601` | BL31 Content Cert 公钥 |
| **TOS_FW_CONTENT_CERT_PK_EXT** | `1.3.6.1.4.1.4128.2100.602` | BL32 Content Cert 公钥 |
| **NT_FW_CONTENT_CERT_PK_EXT** | `1.3.6.1.4.1.4128.2100.603` | BL33 Content Cert 公钥 |

### 查看特定 OID 的扩展

```bash
# 查看 Trusted World PK 扩展
openssl x509 -in trusted_key.crt -text -noout | grep -A 5 "1.3.6.1.4.1.4128.2100.302"

# 查看 SOC_FW_CONTENT_CERT_PK 扩展
openssl x509 -in soc_fw_key.crt -text -noout | grep -A 5 "1.3.6.1.4.1.4128.2100.601"
```

---

## 验证检查清单

### 检查 Trusted Key Certificate

```bash
# 1. 检查 Subject Public Key（应该是 ROT_KEY 的公钥）
openssl x509 -in trusted_key.crt -pubkey -noout | openssl pkey -pubin -text -noout

# 2. 检查扩展中的 Trusted World PK
openssl x509 -in trusted_key.crt -text -noout | grep -A 5 "TrustedWorldPublicKey"

# 3. 检查扩展中的 Non-Trusted World PK
openssl x509 -in trusted_key.crt -text -noout | grep -A 5 "NonTrustedWorldPublicKey"

# 4. 验证与密钥文件匹配
openssl x509 -in trusted_key.crt -pubkey -noout > cert_pubkey.pem
openssl pkey -in rot_key.pem -pubout > rot_pubkey.pem
diff cert_pubkey.pem rot_pubkey.pem  # 应该相同
```

### 检查 SOC_FW_KEY_CERT

```bash
# 1. 检查 Subject Public Key（应该是 TRUSTED_WORLD_KEY 的公钥）
openssl x509 -in soc_fw_key.crt -pubkey -noout | openssl pkey -pubin -text -noout

# 2. 检查扩展中的 Content Cert PK（应该是 SOC_FW_CONTENT_CERT_KEY 的公钥）
openssl x509 -in soc_fw_key.crt -text -noout | grep -A 5 "SoCFirmwareContentCertPK"

# 3. 验证与密钥文件匹配
openssl x509 -in soc_fw_key.crt -pubkey -noout > cert_pubkey.pem
openssl pkey -in trusted_world_key.pem -pubout > tw_pubkey.pem
diff cert_pubkey.pem tw_pubkey.pem  # 应该相同
```

### 检查 SOC_FW_CONTENT_CERT

```bash
# 1. 检查 Subject Public Key（应该是 SOC_FW_CONTENT_CERT_KEY 的公钥）
openssl x509 -in soc_fw_content.crt -pubkey -noout | openssl pkey -pubin -text -noout

# 2. 检查扩展中的 hash（不是公钥，是 hash）
openssl x509 -in soc_fw_content.crt -text -noout | grep -A 5 "SoCAPFirmwareHash"

# 3. 验证与密钥文件匹配
openssl x509 -in soc_fw_content.crt -pubkey -noout > cert_pubkey.pem
openssl pkey -in soc_fw_content_key.pem -pubout > content_pubkey.pem
diff cert_pubkey.pem content_pubkey.pem  # 应该相同
```

---

## 常见问题

### Q1: 如何知道证书中有哪些公钥扩展？

```bash
# 方法 1：查看所有扩展
openssl x509 -in certificate.crt -text -noout | grep -A 10 "X509v3 extensions"

# 方法 2：查看特定 OID
openssl x509 -in certificate.crt -text -noout | grep "1.3.6.1.4.1.4128"

# 方法 3：使用 asn1parse
openssl asn1parse -in certificate.crt -i | grep "OCTET STRING"
```

### Q2: 如何提取扩展中的公钥为文件？

```bash
# 使用 Python 脚本（推荐）
python3 extract_ext_pubkey.py soc_fw_key.crt SOC_FW_CONTENT_CERT_PK > ext_pubkey.pem

# 或者使用 OpenSSL + 手动解析
openssl x509 -in certificate.crt -text -noout | grep -A 10 "OID" | tail -n +2 | xxd -r -p > ext_pubkey.der
openssl pkey -pubin -inform DER -in ext_pubkey.der -out ext_pubkey.pem
```

### Q3: 如何验证公钥是否正确？

```bash
# 1. 提取证书中的公钥
openssl x509 -in cert.crt -pubkey -noout > cert_pubkey.pem

# 2. 从密钥文件提取公钥
openssl pkey -in key.pem -pubout > key_pubkey.pem

# 3. 比较 hash
openssl pkey -pubin -in cert_pubkey.pem | openssl sha256
openssl pkey -pubin -in key_pubkey.pem | openssl sha256
# 两个 hash 应该相同
```

### Q4: 如何查看公钥的详细信息？

```bash
# 查看公钥的详细信息（算法、大小、参数等）
openssl pkey -pubin -in pubkey.pem -text -noout

# 对于 RSA 密钥
openssl rsa -pubin -in pubkey.pem -text -noout

# 对于 ECDSA 密钥
openssl ec -pubin -in pubkey.pem -text -noout
```

---

## 总结

### 查看证书中公钥的方法

1. **Subject Public Key**：
   ```bash
   openssl x509 -in cert.crt -pubkey -noout
   openssl x509 -in cert.crt -text -noout | grep -A 20 "Subject Public Key Info"
   ```

2. **扩展中的公钥**：
   ```bash
   openssl x509 -in cert.crt -text -noout | grep -A 5 "OID"
   # 或使用 Python 脚本提取
   ```

3. **验证公钥**：
   ```bash
   # 比较证书中的公钥与密钥文件的公钥
   openssl x509 -in cert.crt -pubkey -noout > cert_pubkey.pem
   openssl pkey -in key.pem -pubout > key_pubkey.pem
   diff cert_pubkey.pem key_pubkey.pem
   ```

### 关键命令速查

| 操作 | 命令 |
|------|------|
| 查看 Subject Public Key | `openssl x509 -in cert.crt -pubkey -noout` |
| 查看完整证书信息 | `openssl x509 -in cert.crt -text -noout` |
| 查看所有扩展 | `openssl x509 -in cert.crt -text -noout \| grep -A 10 "X509v3 extensions"` |
| 查看特定 OID | `openssl x509 -in cert.crt -text -noout \| grep -A 5 "OID"` |
| 提取公钥为文件 | `openssl x509 -in cert.crt -pubkey -noout > pubkey.pem` |
| 查看公钥详情 | `openssl pkey -pubin -in pubkey.pem -text -noout` |

---

**参考文档**：
- OpenSSL 文档：https://www.openssl.org/docs/
- TF-A 证书工具：`tools/cert_create/`
- TF-A OID 定义：`include/tools_share/tbbr_oid.h`
