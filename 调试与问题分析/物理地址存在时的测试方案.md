# 物理地址存在时的测试方案

## 问题描述

**你的情况**：
- PLAT_PHY_ADDR_SPACE_SIZE = 4GB
- 物理地址0x7FFFF000在4GB范围内
- **这个地址可能实际存在物理内存**
- 访问时不会触发总线错误
- 测试无法正常工作

## 问题分析

### 为什么物理地址存在会导致测试失败？

**如果物理地址存在**：
```
访问虚拟地址0x7FFFF000
    ↓
MMU翻译：虚拟地址 → 物理地址0x7FFFF000
    ↓
总线访问物理地址0x7FFFF000
    ↓
✅ 物理地址存在，访问成功
    ↓
❌ 没有触发总线错误
    ↓
❌ 没有触发同步EA异常
    ↓
❌ 测试无法验证FFH模式
```

**如果物理地址不存在**：
```
访问虚拟地址0x7FFFF000
    ↓
MMU翻译：虚拟地址 → 物理地址0x7FFFF000
    ↓
总线访问物理地址0x7FFFF000
    ↓
❌ 物理地址不存在，总线返回错误
    ↓
✅ 触发同步EA异常
    ↓
✅ 测试可以验证FFH模式
```

## 解决方案

### 方案1：使用超出物理地址空间的地址（推荐）⭐⭐⭐⭐⭐

**使用大于4GB的地址**：

```c
// 修改test_ea_ffh.c
#define TEST_ADDRESS	UL(0x100000000)  // 4GB，超出物理地址空间
// 或者
#define TEST_ADDRESS	UL(0x200000000)  // 8GB，更安全
```

**优点**：
- ✅ 简单直接
- ✅ 确保物理地址不存在
- ✅ 不需要修改其他代码

**注意**：
- 需要确保虚拟地址空间也足够大
- 如果PLAT_VIRT_ADDR_SPACE_SIZE也是4GB，可能需要调整

### 方案2：使用设备地址空间中的保留区域

**查找设备地址空间中的保留区域**：

```c
// 使用设备地址空间中的保留区域
// 例如：0x80000000 - 0xFFFFFFFF（设备地址空间）
#define TEST_ADDRESS	UL(0xFFFFFFFF)  // 设备地址空间的末尾
// 或者
#define TEST_ADDRESS	UL(0xE0000000)  // 设备地址空间中的保留区域
```

**优点**：
- ✅ 在虚拟地址空间范围内
- ✅ 通常不会有实际物理内存

**缺点**：
- ❌ 需要确认该地址确实不存在
- ❌ 不同平台可能不同

### 方案3：使用未映射的设备区域

**查找平台定义中的设备地址范围**：

```c
// 查看plat_setup.c中的设备映射
// 使用不在设备映射范围内的地址
#define TEST_ADDRESS	UL(0x50000000)  // 设备地址空间中的未映射区域
```

### 方案4：动态查找不存在的地址

**在运行时查找不存在的地址**：

```c
// 尝试映射多个地址，找到第一个失败的
uintptr_t find_invalid_address(void)
{
    uintptr_t test_addrs[] = {
        0x7FFFF000,
        0x100000000,  // 4GB
        0x200000000,  // 8GB
        0xE0000000,   // 设备地址空间
        0xFFFFFFFF,   // 最大地址
    };
    
    for (int i = 0; i < sizeof(test_addrs)/sizeof(test_addrs[0]); i++) {
        // 尝试访问，如果触发异常，说明地址不存在
        // 或者检查地址是否在已知的物理内存范围内
    }
    
    return 0;  // 返回找到的地址
}
```

### 方案5：使用平台特定的测试地址

**在平台定义中指定测试地址**：

```c
// plat/arm/fvp/include/platform_def.h
#ifndef TEST_EA_FFH_ADDRESS
#define TEST_EA_FFH_ADDRESS    0x100000000  // 4GB，超出物理地址空间
#endif

// test_ea_ffh.c
#define TEST_ADDRESS    TEST_EA_FFH_ADDRESS
```

**优点**：
- ✅ 平台可以自定义
- ✅ 不同平台可以使用不同的地址

## 推荐方案

### 方案A：使用4GB地址（最简单）

```c
// test_ea_ffh.c
#define TEST_ADDRESS	UL(0x100000000)  // 4GB，超出物理地址空间
```

**原因**：
- 如果你的物理地址空间是4GB（0x0 - 0xFFFFFFFF）
- 0x100000000（4GB）肯定不存在
- 访问时会触发总线错误

**注意**：
- 需要确保PLAT_VIRT_ADDR_SPACE_SIZE >= 4GB
- 如果虚拟地址空间也是4GB，可能需要调整

### 方案B：使用设备地址空间中的保留区域

```c
// test_ea_ffh.c
#define TEST_ADDRESS	UL(0xE0000000)  // 设备地址空间中的保留区域
```

**原因**：
- 设备地址空间通常有保留区域
- 这些区域通常没有实际物理设备
- 访问时会触发总线错误

## 验证方法

### 方法1：检查地址是否在物理地址空间内

```c
void check_test_address(void)
{
    uintptr_t test_addr = TEST_ADDRESS;
    uint64_t phy_addr_space = PLAT_PHY_ADDR_SPACE_SIZE;
    
    tftf_testcase_printf("TEST_ADDRESS = 0x%lx\n", test_addr);
    tftf_testcase_printf("PLAT_PHY_ADDR_SPACE_SIZE = 0x%llx\n", phy_addr_space);
    
    if (test_addr >= phy_addr_space) {
        tftf_testcase_printf("✅ 地址超出物理地址空间，应该不存在\n");
    } else {
        tftf_testcase_printf("❌ 地址在物理地址空间内，可能存在\n");
        tftf_testcase_printf("建议: 使用大于0x%llx的地址\n", phy_addr_space);
    }
}
```

### 方法2：尝试访问并检查是否触发异常

```c
test_result_t test_address_validity(void)
{
    int rc;
    
    // 创建映射
    rc = mmap_add_dynamic_region(TEST_ADDRESS, TEST_ADDRESS, PAGE_SIZE,
                                  MT_DEVICE | MT_RO | MT_NS);
    if (rc != 0) {
        return TEST_RESULT_FAIL;
    }
    
    // 尝试访问
    // 如果地址不存在，应该触发异常
    // 如果地址存在，访问会成功（但这不是我们想要的）
    uint32_t value = mmio_read_32(TEST_ADDRESS);
    
    // 如果访问成功，说明地址存在，不适合测试
    tftf_testcase_printf("地址访问成功，值=0x%x\n", value);
    tftf_testcase_printf("警告: 地址可能存在，可能无法触发EA异常\n");
    
    mmap_remove_dynamic_region(TEST_ADDRESS, PAGE_SIZE);
    return TEST_RESULT_SUCCESS;
}
```

## 具体修改建议

### 修改test_ea_ffh.c

```c
// 方案1：使用4GB地址（推荐）
#define TEST_ADDRESS	UL(0x100000000)  // 4GB

// 或者方案2：使用设备地址空间
#define TEST_ADDRESS	UL(0xE0000000)  // 设备地址空间

// 或者方案3：平台定义
#ifndef TEST_EA_FFH_ADDRESS
#define TEST_EA_FFH_ADDRESS    0x100000000
#endif
#define TEST_ADDRESS    TEST_EA_FFH_ADDRESS
```

### 检查虚拟地址空间大小

```c
// 确保虚拟地址空间足够大
// 如果PLAT_VIRT_ADDR_SPACE_SIZE = 4GB
// 使用0x100000000（4GB）会超出范围
// 需要使用ERANGE检查或使用更小的地址
```

## 总结

**问题**：
- 物理地址空间是4GB
- 0x7FFFF000在4GB范围内，可能实际存在
- 访问时不会触发总线错误
- 测试无法正常工作

**解决方案**：
1. **⭐⭐⭐⭐⭐ 使用4GB地址（0x100000000）**
   - 超出物理地址空间，肯定不存在
   - 简单直接

2. **⭐⭐⭐⭐ 使用设备地址空间中的保留区域**
   - 如0xE0000000
   - 通常没有实际设备

3. **⭐⭐⭐ 平台定义测试地址**
   - 不同平台可以使用不同的地址
   - 更灵活

**建议**：
- 首先尝试使用0x100000000（4GB）
- 如果虚拟地址空间也是4GB，使用设备地址空间
- 添加验证代码确认地址确实不存在

