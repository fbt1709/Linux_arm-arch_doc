# SPSR_EL3 = 0x80000249 分析

## 寄存器值解析

**SPSR_EL3 = 0x80000249 = 0b10000000000000000000001001001001**

## 位域分析

| 位域 | 值 | 含义 |
|------|-----|------|
| **M[3:0]** | **0x9** | **异常发生时的异常等级和执行状态** |
| M[4] | 0 | AArch32执行状态 |
| F (bit 25) | 1 | FIQ被掩码 |
| I (bit 26) | 0 | IRQ未掩码 |
| **A (bit 27)** | **0** | **SError未掩码** |
| D (bit 28) | 0 | 调试异常未掩码 |
| ... | ... | ... |
| bit 31 | 1 | 保留位 |

## 关键发现

### M[3:0] = 0x9 分析

在AArch64中，M[3:0]的编码：
- **M[3:2]**：异常等级（00=EL0, 01=EL1, 10=EL2, 11=EL3）
- **M[1:0]**：SP选择（00=SP_EL0, 01=SP_ELx）

**0x9 = 0b1001**
- M[3:2] = 0b10 = **EL2**
- M[1:0] = 0b01 = **SP_EL2**

**M[3:0] = 0x9 = EL2h (EL2 with SP_EL2)**

这意味着：
- **异常发生在EL2** ✗
- 使用SP_EL2作为栈指针
- **SError路由到了EL2，而不是EL3** ✗

### 其他关键位

- **A位（bit 27）= 0**：SError未被掩码，可以触发
- **F位（bit 25）= 1**：FIQ被掩码
- **I位（bit 26）= 0**：IRQ未掩码
- **M[4] = 0**：AArch32执行状态（但这是异常发生时的状态）

## 结论

### ❌ SError路由到EL2，而不是EL3

**SPSR_EL3.M[3:0] = 0x9 (EL2h)** 表明：
1. **SError路由到了EL2** ✗
2. 异常发生在EL2
3. 使用SP_EL2作为栈指针

### 与SCR_EL3.EA的关系

- **SCR_EL3.EA = 1**（之前检测到0x73D，EA=1）
- **SPSR_EL3.M[3:0] = 0x9 (EL2)** ✗
- **两者不一致**：虽然SCR_EL3.EA=1，但SError却路由到了EL2

### 可能的原因

1. **EL2存在且启用**：如果系统有EL2（虚拟化），SError可能先路由到EL2
2. **EL2的路由配置**：HCR_EL2可能有路由配置覆盖了SCR_EL3.EA
3. **异常处理顺序**：ARM架构中，异常可能先被EL2处理，然后才到EL3

## 为什么Uncontainable错误路由到TFTF？

既然普通SError能路由到EL3，但Uncontainable错误路由到TFTF，可能的原因：

### 1. Uncontainable错误的特殊行为

Uncontainable错误可能有**独立的路由机制**，不受SCR_EL3.EA控制：

- **ERXPFGCTL_UC_BIT**可能触发特殊的路由路径
- 某些平台可能对Uncontainable错误有特殊处理

### 2. 错误注入时的执行上下文

- **普通SError**：在TFTF（EL1）执行时触发，路由到EL3 ✓
- **Uncontainable错误**：可能在注入时就有特殊的路由配置

### 3. RAS错误记录的路由配置

ERXCTLR_EL1或ERXPFGCTL_EL1可能包含路由配置，覆盖了SCR_EL3.EA。

## 验证建议

### 1. 对比测试

```c
// 测试1：普通SError（已确认路由到EL3）
test_normal_serror();  // SPSR_EL3.M[3:0] = 0x9 ✓

// 测试2：Uncontainable错误
test_uncontainable();  // 检查SPSR_EL1（如果路由到EL1）
```

### 2. 检查Uncontainable错误时的SPSR

如果Uncontainable错误路由到TFTF，应该检查：
- **SPSR_EL1.M[3:0]**（如果异常在EL1处理）
- 或者检查是否根本没有异常处理（错误被忽略）

### 3. 检查RAS寄存器配置

```c
// 在注入Uncontainable错误后检查
msr errselr_el1, #0
isb
mrs x0, erxctlr_el1
mrs x1, erxpfgctl_el1
// 检查是否有路由相关的配置位
```

## 总结

**SPSR_EL3 = 0x80000249 表明**：
- ❌ **SError路由到EL2**（M[3:0] = 0x9 = EL2h）
- ❌ **与SCR_EL3.EA=1不一致**
- ❓ **虽然SCR_EL3.EA=1，但SError却路由到了EL2**

**关键问题**：
1. **为什么SCR_EL3.EA=1，但SError路由到EL2？**
   - 可能EL2有独立的路由配置（HCR_EL2）
   - 可能异常处理顺序导致先到EL2

2. **需要检查HCR_EL2配置**：
   - HCR_EL2.AMO (bit 5)：SError路由到EL2
   - HCR_EL2.TGE (bit 27)：EL2配置

3. **为什么Uncontainable错误路由到TFTF？**
   - 可能是Uncontainable错误的特殊路由机制
   - 需要检查ERXCTLR_EL1和ERXPFGCTL_EL1的配置

